From ded188c84cc27f026df24c7a7af283d061834df8 Mon Sep 17 00:00:00 2001
From: Alexander Graf <agraf@suse.de>
Date: Wed, 12 Dec 2012 19:11:30 +0100
Subject: [PATCH 032/169] Legacy Patch kvm-qemu-preXX-dictzip3.patch

---
 block/tar.c | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

Index: qemu-1.6.0+dfsg/block/tar.c
===================================================================
--- qemu-1.6.0+dfsg.orig/block/tar.c	2013-11-05 22:23:22.131418664 +0000
+++ qemu-1.6.0+dfsg/block/tar.c	2013-11-05 22:23:22.123418686 +0000
@@ -83,7 +83,8 @@
     return !strncmp(str + str_len - end_len, end, end_len);
 }
 
-static int is_target_file(BlockDriverState *bs, char *filename)
+static int is_target_file(BlockDriverState *bs, char *filename,
+                          char *header)
 {
     int retval = 0;
 
@@ -99,10 +100,17 @@
     if (str_ends(filename, ".vmdk"))
         retval = 1;
 
+    if (retval &&
+        (header[OFFS_TYPE] != '0') &&
+        (header[OFFS_TYPE] != 'S')) {
+        retval = 0;
+    }
+
     dprintf("does filename %s match? %s\n", filename, retval ? "yes" : "no");
 
     /* make sure we're not using this name again */
     filename[0] = '\0';
+
     return retval;
 }
 
@@ -229,12 +237,13 @@
             bdrv_pread(s->hd, header_offs - s->file_len, s->longfile,
                        sizeof(s->longfile));
             s->longfile[sizeof(s->longfile)-1] = '\0';
+            real_file = header;
         } else if (s->longfile[0]) {
             real_file = s->longfile;
         } else {
             real_file = header;
         }
-    } while(!is_target_file(bs, real_file));
+    } while(!is_target_file(bs, real_file, header));
 
     /* We found an image! */
 
