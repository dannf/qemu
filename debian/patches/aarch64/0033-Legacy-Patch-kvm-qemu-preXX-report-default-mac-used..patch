From 0ed690619af417a4ec42e6f7263053c8b88d85be Mon Sep 17 00:00:00 2001
From: Alexander Graf <agraf@suse.de>
Date: Wed, 12 Dec 2012 19:11:31 +0100
Subject: [PATCH 033/169] Legacy Patch
 kvm-qemu-preXX-report-default-mac-used.patch

---
 net/net.c | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

Index: qemu-1.6.0+dfsg/net/net.c
===================================================================
--- qemu-1.6.0+dfsg.orig/net/net.c	2013-11-05 22:23:22.327418157 +0000
+++ qemu-1.6.0+dfsg/net/net.c	2013-11-05 22:23:22.323418167 +0000
@@ -139,6 +139,27 @@
              macaddr[3], macaddr[4], macaddr[5]);
 }
 
+static void default_mac_check(void)
+{
+    static const MACAddr def_mac = { .a = { 0x52,0x54,0x00,0x12,0x34,0x56 } };
+    static int warned = 0;
+    int i;
+
+    for (i = 0; i < MAX_NICS; i++)
+    {
+        if (!nd_table[i].used)
+            continue;
+        if (memcmp(nd_table[i].macaddr.a, def_mac.a, 5))
+            continue;
+        if (nd_table[i].macaddr.a[5] >= 0x56 &&
+            nd_table[i].macaddr.a[5] < 0x56  + MAX_NICS && !warned) {
+            warned = 1;
+            fprintf(stderr, "Warning: default mac address being used, creating "
+                    "potential for address conflict\n");
+        }
+    }
+}
+
 void qemu_macaddr_default_if_unset(MACAddr *macaddr)
 {
     static int index = 0;
@@ -1179,6 +1200,7 @@
     if (qemu_opts_foreach(net, net_init_client, NULL, 1) == -1) {
         return -1;
     }
+    default_mac_check();
 
     return 0;
 }
