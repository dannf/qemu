From 3257bdc6997e4cbc5fcec123515fde8dc0e600d8 Mon Sep 17 00:00:00 2001
From: Alexander Graf <agraf@suse.de>
Date: Wed, 20 Feb 2013 04:15:30 +0100
Subject: [PATCH 069/169] fix fmov

---
 target-arm/translate-a64.c | 25 ++++++++-----------------
 1 file changed, 8 insertions(+), 17 deletions(-)

Index: qemu-1.6.0+dfsg/target-arm/translate-a64.c
===================================================================
--- qemu-1.6.0+dfsg.orig/target-arm/translate-a64.c	2013-11-05 22:23:30.447397135 +0000
+++ qemu-1.6.0+dfsg/target-arm/translate-a64.c	2013-11-05 22:23:30.443397145 +0000
@@ -96,6 +96,7 @@
         int numvfpregs = 32;
         for (i = 0; i < numvfpregs; i++) {
             uint64_t v = float64_val(env->vfp.regs[i * 2]);
+            if (!v) continue;
             cpu_fprintf(f, "d%02d=%016" PRIx64 "\n", i, v);
         }
         cpu_fprintf(f, "FPSCR: %08x\n", (int)env->vfp.xregs[ARM_VFP_FPSCR]);
@@ -640,7 +641,7 @@
         return;
     }
 
-    tcg_op2 = get_shifti(rm, shift_type, shift_amount);
+    tcg_op2 = get_shifti(rm, shift_type, shift_amount & (is_32bit ? 31 : 63));
     if (is_n) {
         tcg_gen_not_i64(tcg_op2, tcg_op2);
     }
@@ -1751,27 +1752,17 @@
                 ((rmode & 1) ? 0x4 : 0) |
                 (itof ? 0x8 : 0)) {
         case 0x0:
-            tcg_gen_ld32u_i64(cpu_reg(rd), cpu_env, freg_offs + sizeof(float32));
+            tcg_gen_ld32u_i64(cpu_reg(rd), cpu_env, freg_offs);
             break;
         case 0x1:
+        case 0x2 | 0x4:
             tcg_gen_ld_i64(cpu_reg(rd), cpu_env, freg_offs);
             break;
-        case 0x2:
-            tcg_gen_ld_i64(cpu_reg(rd), cpu_env, freg_offs);
-            break;
-        case 0x6:
-            tcg_gen_ld_i64(cpu_reg(rd), cpu_env, freg_offs);
-            break;
-        case 0x8:
-            tcg_gen_st32_i64(cpu_reg(rn), cpu_env, freg_offs + sizeof(float32));
-            break;
-        case 0x9:
-            tcg_gen_st_i64(cpu_reg(rn), cpu_env, freg_offs);
-            break;
-        case 0xa:
-            tcg_gen_st_i64(cpu_reg(rn), cpu_env, freg_offs);
+        case 0x8 | 0x0:
+            tcg_gen_st32_i64(cpu_reg(rn), cpu_env, freg_offs);
             break;
-        case 0xe:
+        case 0x8 | 0x1:
+        case 0x8 | 0x2 | 0x4:
             tcg_gen_st_i64(cpu_reg(rn), cpu_env, freg_offs);
             break;
         default:
