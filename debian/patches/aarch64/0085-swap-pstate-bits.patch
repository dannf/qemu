From 203fab14d8edb2f24a59e92851f08acd4cd4e43e Mon Sep 17 00:00:00 2001
From: Alexander Graf <agraf@suse.de>
Date: Thu, 28 Feb 2013 00:04:09 +0100
Subject: [PATCH 085/169] swap pstate bits

---
 target-arm/cpu.h           | 8 ++++----
 target-arm/translate-a64.c | 6 ++++++
 2 files changed, 10 insertions(+), 4 deletions(-)

Index: qemu-1.6.0+dfsg/target-arm/cpu.h
===================================================================
--- qemu-1.6.0+dfsg.orig/target-arm/cpu.h	2013-11-05 22:23:33.559389079 +0000
+++ qemu-1.6.0+dfsg/target-arm/cpu.h	2013-11-05 22:23:33.555389090 +0000
@@ -294,10 +294,10 @@
 #endif
 }
 
-#define PSTATE_N  (1 << 0)
-#define PSTATE_Z  (1 << 1)
-#define PSTATE_C  (1 << 2)
-#define PSTATE_V  (1 << 3)
+#define PSTATE_N  (1 << 3)
+#define PSTATE_Z  (1 << 2)
+#define PSTATE_C  (1 << 1)
+#define PSTATE_V  (1 << 0)
 
 /* you can call this signal handler from your SIGBUS and SIGSEGV
    signal handlers to inform the virtual CPU of exceptions. non zero
Index: qemu-1.6.0+dfsg/target-arm/translate-a64.c
===================================================================
--- qemu-1.6.0+dfsg.orig/target-arm/translate-a64.c	2013-11-05 22:23:33.559389079 +0000
+++ qemu-1.6.0+dfsg/target-arm/translate-a64.c	2013-11-05 22:23:33.555389090 +0000
@@ -819,6 +819,12 @@
         tcg_gen_shri_i64(tcg_carry, pstate, PSTATE_C);
         tcg_gen_andi_i64(tcg_carry, tcg_carry, 1);
         tcg_gen_add_i64(tcg_result, tcg_result, tcg_carry);
+#if 0 /* XXX This is how the 32bit target does it, but the spec doesn't sound like it */
+        if (sub_op) {
+            tcg_gen_subi_i64(tcg_result, tcg_result, 1);
+        }
+#endif
+        tcg_temp_free_i64(tcg_carry);
     }
 
     if (setflags) {
