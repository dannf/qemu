From 0dd22d0c5cd1dcdccd5df953f1981d461d3054e5 Mon Sep 17 00:00:00 2001
From: Michael Matz <matz@suse.de>
Date: Sun, 7 Apr 2013 02:20:59 +0200
Subject: [PATCH 143/169] Fix decoding of floating<->fixed conversions

The rmode field was shifted by one bit.
---
 target-arm/translate-a64.c | 18 +++++++++++++-----
 1 file changed, 13 insertions(+), 5 deletions(-)

Index: qemu-1.6.0+dfsg/target-arm/translate-a64.c
===================================================================
--- qemu-1.6.0+dfsg.orig/target-arm/translate-a64.c	2013-11-05 22:23:45.215358908 +0000
+++ qemu-1.6.0+dfsg/target-arm/translate-a64.c	2013-11-05 22:23:45.207358928 +0000
@@ -1974,20 +1974,28 @@
     bool is_s = get_bits(insn, 29, 1);
     int type = get_bits(insn, 22, 2);
     int opcode = get_bits(insn, 16, 3);
-    int rmode = get_bits(insn, 20, 2);
+    int rmode = get_bits(insn, 19, 2);
     bool direction;
 
-    if (is_s || (type > 1) || (opcode > 1)) {
+    if (is_s || (type > 1) || (opcode > 3)) {
         unallocated_encoding(s);
         return;
     }
 
     switch (rmode) {
-    case 0x1: /* [S|U]CVTF (scalar->float) */
-        direction = 0;
+    case 0x0: /* [S|U]CVTF (scalar->float) */
+	if (opcode < 2) {
+	    unallocated_encoding(s);
+	    return;
+	}
+        direction = false;
         break;
     case 0x3: /* FCVTZ[S|U] (float->scalar) */
-        direction = 1;
+	if (opcode > 1) {
+	    unallocated_encoding(s);
+	    return;
+	}
+        direction = true;
         break;
     default:
         unallocated_encoding(s);
